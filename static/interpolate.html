<!DOCTYPE html>
<head>
<meta charset="utf-8" />
<title>Audio Socket Example</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
<script>

var audioContext = new (window.AudioContext || window.webkitAudioContext)();

var bufferSize = 1024;
var myPCMProcessingNode = audioContext.createScriptProcessor(bufferSize, 1, 1);
var tempData = new Float32Array(320);
var audioData = new Float32Array(882);

var source;


myPCMProcessingNode.onaudioprocess = function(e) {
    var output = e.outputBuffer.getChannelData(0);
    for (var i=0; i < bufferSize; i++ ){
        output[i] = audioData[i];

    }
}



function int16ToFloat32(inputArray, startIndex, length) {
    var output = new Float32Array(inputArray.length-startIndex);
    for (var i = startIndex; i < length; i++) {
        var int = inputArray[i];
        // If the high bit is on, then it is a negative number, and actually counts backwards.
        var float = (int >= 0x8000) ? -(0x10000 - int) / 0x8000 : int / 0x7FFF;
        output[i] = float;
    }
    return output;
}

function interpolateArray(data, fitCount) {
    var linearInterpolate = function (before, after, atPoint) {
        return before + (after - before) * atPoint;
    };

    var newData = new Array();
    var springFactor = new Number((data.length - 1) / (fitCount - 1));
    newData[0] = data[0]; // for new allocation
    for ( var i = 1; i < fitCount - 1; i++) {
        var tmp = i * springFactor;
        var before = new Number(Math.floor(tmp)).toFixed();
        var after = new Number(Math.ceil(tmp)).toFixed();
        var atPoint = tmp - before;
        newData[i] = linearInterpolate(data[before], data[after], atPoint);
    }
    newData[fitCount - 1] = data[data.length - 1]; // for new allocation
    return newData;
};


function connect() {
	source = audioContext.createBufferSource();
	source.connect(myPCMProcessingNode);
	myPCMProcessingNode.connect(audioContext.destination);
    var ws = new WebSocket("ws://audiosocket.sammachin.com:8000/browser");
    ws.binaryType = 'arraybuffer';
    ws.onopen = function() {
        console.log('Connected');
    };
    ws.onmessage = function(event) {
        tempData = int16ToFloat32(new Int16Array(event.data), 0, 320);
        audioData = interpolateArray(tempData, 882);
    };
}

</script>
<center>
	<h2> Basic Interpolation</h2>
    <p> call 07520 616161 then click connect</p>
<form>
<input type="button" style="height: 75px; width: 150px;" value="Connect" onClick="connect()">
</form>
</center>
<audio>

</body>
</html>